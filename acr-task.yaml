version: v1.1.0
steps:
  # Restore .NET dependencies
  - cmd: mcr.microsoft.com/dotnet/sdk:8.0 dotnet restore AcrTasksDemo.csproj
    workingDirectory: /workspace
    
  # Build the .NET application
  - cmd: mcr.microsoft.com/dotnet/sdk:8.0 dotnet build AcrTasksDemo.csproj -c Release --no-restore
    workingDirectory: /workspace
    
  # Run .NET tests
  - cmd: mcr.microsoft.com/dotnet/sdk:8.0 dotnet test --no-build -c Release --logger trx --results-directory /workspace/test-results
    workingDirectory: /workspace
    continueOnError: true
    
  # Build the Docker image
  - build: -t $Registry/acr-tasks-csharp-demo:$ID -t $Registry/acr-tasks-csharp-demo:latest .
    
  # Test the container by running it briefly
  - cmd: docker run --rm -d --name test-container -p 8080:8080 $Registry/acr-tasks-csharp-demo:$ID
    continueOnError: true
    
  # Wait a moment for container to start
  - cmd: sleep 10
    
  # Test the health endpoint (if container started)
  - cmd: curl -f http://localhost:8080/health || echo "Health check skipped"
    continueOnError: true
    
  # Stop test container
  - cmd: docker stop test-container || echo "No test container to stop"
    continueOnError: true
    
  # Push the image to registry
  - push: 
    - $Registry/acr-tasks-csharp-demo:$ID
    - $Registry/acr-tasks-csharp-demo:latest